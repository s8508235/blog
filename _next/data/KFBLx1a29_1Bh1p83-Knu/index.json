{"pageProps":{"posts":[{"slug":"limit-program-resource","frontmatter":{"title":"使用 cgroups 來限制資源","date":"November 20, 2020","description":"cgroups 是 control groups，為 linux 核心的一個功能"},"excerpt":"","content":"\n來限制 memory 來簡單示範一下 cgroups\n\n### Disclaimer\n我不知道這是不是正確的作法，因為從 docker 得到了 cgroups 相關知識，用來這邊，那麼進入正文\n\n---\n### Installation\n```\napt install cgroup-tools\n```\n\nor\n``` \nyum install libcgroup\nyum install libcgroup-tools\n```\n### 建立 cgroup\n\n```cgcreate  -g subsystems:path``` <del>詳情請洽 red hat 官網</del>\n\n關於 subsystem 也可以去 `/sys/fs/cgroup` 下面看內建的\n\n也會看到其他教學是直接在 `/sys/fs/cgroup/` 下直接加資料夾，也會自動幫你加完相關檔案\n\n```\nsudo cgcreate -g memory:/mem_test\n```\n\n### 增加限制\n\n可以看到在新增 cgroup 後，可以發現 `/sys/fs/cgroup/memory/memory_test` 下面多了一些檔案\n\n這邊主要看 `memory.limit_in_bytes` 和 `memory.usage_in_bytes` 就好，\n\n用 \n```\ncat /sys/fs/cgroup/memory/memory_test/memory.limit_in_bytes\n``` \n或 \n```\ncgget -g memory:mem_test | grep memory.limit_in_bytes\n``` \n來查看設定，接著是用 \n```\ncgset -r memory.limit_in_bytes=100G mem_test\n``` \n<del>為什麼這邊不一樣啊! <small>如果沒有變的話就加上 sudo </small></del>\n\n### 執行程式\n\n`cgexec -g memory:/mem_test command [argument]`\n\n例如:\n```\ncgexec -g memory:/mem_test ping 8.8.8.8\n```\n\n### 觀察\n\n可以使用以下指令來看在這個 cgroup 執行的 process\n```\nsystemd-cgls memory:/mem_test\n``` \n\n看在 cgroup 使用的 memory <del>應該有更好的方法，歡迎提供</del>\n\n```\nwatch -n 1 \"cgget -g memory:mem_test | grep memory.usage_in_bytes\"\n``` \n\n\n### 刪除 cgroup\n\n```\nsudo cgdelete memory:/mem_test\n```\n\n### Conclusion\n\n這樣就完成簡單的限制資源，還有其他 subsystem ( cpu, blkio, devices 等等) 可以實作，也可以互相組合，雖然是被大量應用在各種容器技術中，但也是可以簡單拿出來用用看。<del>大概吧</del>\n\n### Reference\n- [Red hat Resource management Chapter 2](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-using_control_groups)"}]},"__N_SSG":true}
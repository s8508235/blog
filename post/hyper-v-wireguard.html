<!DOCTYPE html><html lang="zh-TW"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><title>Hyper V wireguard | s8508235&#x27;s blog</title><meta name="description" content="add hyper v vm and setup wireguard server"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="Hyper V wireguard"/><meta name="og:description" property="og:description" content="add hyper v vm and setup wireguard server"/><link rel="icon" type="image/png" href="/blog/favicon.ico"/><link rel="apple-touch-icon" href="/blog/favicon.ico"/><meta name="next-head-count" content="10"/><link rel="preload" href="/blog/_next/static/css/e1a287d777908626.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/e1a287d777908626.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog/_next/static/chunks/webpack-c6e85cc450395c4f.js" defer=""></script><script src="/blog/_next/static/chunks/framework-24fda4117f092221.js" defer=""></script><script src="/blog/_next/static/chunks/main-45a06a8026e57e18.js" defer=""></script><script src="/blog/_next/static/chunks/pages/_app-492e99d0a17aabe9.js" defer=""></script><script src="/blog/_next/static/chunks/827-be7497ae10ef2b4b.js" defer=""></script><script src="/blog/_next/static/chunks/123-2ecf6c42e22944db.js" defer=""></script><script src="/blog/_next/static/chunks/552-14dffc3b36c9d95b.js" defer=""></script><script src="/blog/_next/static/chunks/pages/post/%5Bslug%5D-3b9db917b5101652.js" defer=""></script><script src="/blog/_next/static/6ZXqLECLhYggqrX93Splm/_buildManifest.js" defer=""></script><script src="/blog/_next/static/6ZXqLECLhYggqrX93Splm/_ssgManifest.js" defer=""></script><script src="/blog/_next/static/6ZXqLECLhYggqrX93Splm/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="w-full min-h-screen dark:bg-gray-700 dark:text-white"><div class="max-w-screen-sm px-4 py-12 mx-auto antialiased font-body"><header class="flex items-center justify-between  mb-2"><div class="max-w-md"><h1><a class="text-2xl font-black text-blue-800 no-underline font-display dark:text-blue-400" href="/blog">Minimal blog</a></h1></div></header><main><article><header class="mb-8"><h1 class="mb-2 text-5xl font-black leading-none font-display">Hyper V wireguard</h1><p class="text-sm">June 30, 2023</p></header><div class="mb-4 prose lg:prose-lg dark:prose-dark"><h2>Prerequisite knowledge</h2><ul><li>Hyper V</li><li>Wireguard</li></ul><h2>Step 1 新增 VM</h2><p><a target="_blank" rel="noopener noreferrer" href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v">新增 hyper-v VM</a>
(個人是使用 ubuntu server)</p><p><a target="_blank" rel="noopener noreferrer" href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines">並使用 external switch</a></p><h2>Step 2 安裝 wireguard</h2><p>新增 user 等 linux 設定這邊跳過，需要的話請參考<a target="_blank" rel="noopener noreferrer" href="https://linux.vbird.org/linux_basic/centos7/0410accountmanager.php">鳥哥私房菜</a></p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-sh" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>sudo apt install wireguard</span></code></pre><h2>Step 3 設定 server</h2><p><a target="_blank" rel="noopener noreferrer" href="https://www.wireguardconfig.com/">生成 wireguard config</a> (記得不要關掉，後面還會用到)</p><p>加上 DNS 後(建議)將 server config 存成 <code>wg0.conf</code> 並使用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-sh" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>wg-quick up ./wg0.conf</span></code></pre><p>開啟 server (wg-quick 需要 sudo)。</p><p>如網路沒通，需要在 <code>wg0.conf</code> 的<code>[Interface]</code>中加上</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-conf" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>PreUp = sysctl -w net.ipv4.ip_forward=1
</span>PreUp = sysctl -w net.ipv6.conf.all.forwarding=1</code></pre><p>讓網路能夠 forward (或直接跑這兩個指令，只需要設定一次)。</p><h2>Step 3.5 查看 server</h2><p>到這邊 server 的部分就結束了，
可以使用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>watch -n 1 sudo wg</span></code></pre><p>來看 wireguard 的情況。</p><h2>Step 4 client 安裝</h2><p>在需要的機器上下載 <a target="_blank" rel="noopener noreferrer" href="https://www.wireguard.com/install/">wireguard 用戶端</a></p><p>並將 client config (生成 wireguard config 部分) 存成 <code>wg0.conf</code> 將其匯入用戶端便可使用</p><h2>Optional</h2><p>因為通常家裡都是浮動 IP，所以需要 DDNS，</p><p>這邊使用 <a target="_blank" rel="noopener noreferrer" href="https://www.duckdns.org/">DuckDNS</a>，記得先安裝 curl</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-sh" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>sudo apt install curl</span></code></pre><p>註冊完後可以有 5 個 DDNS 的名額，依照<a target="_blank" rel="noopener noreferrer" href="https://www.duckdns.org/install.jsp">linux cron 的步驟</a>設定，
(DuckDNS 很貼心都有換成你自己的 token 和 domain)</p><p>並可得到 <code>xxx.duckdns.org</code> 的 domain，將其輸入在 Endpoint 的地方即可( port 要留著)。</p><h2>Final words</h2><p>將之前寫的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/s8508235/wireguard-terraform-install">AWS wireguard setup</a> 用 windows hyper-v 實現一次，
後來才發現有別人寫好的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/micahmo/WgServerforWindows">windows solution</a>，有興趣的可以研究一下。</p></div><hr class="mt-4"/><footer><div class="flex items-center space-x-3 mt-8 mb-16"><div class="flex-shrink-0 mb-0 overflow-hidden rounded-full w-14 h-14"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2756%27%20height=%2756%27/%3e"/></span><img alt="Profile" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;filter:blur(20px);background-size:cover;background-image:url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAAAAAAQMlOCAAAASklEQVR42gE/AMD/AG/Q1dbUplpPAKD/7eHs1QBBAKD85tivzKBnAIbs7eDW3/ClAIvJyODi3ue9ACmwueTk4ejCACBf19TX1N6z530ojUkGi+cAAAAASUVORK5CYII=&quot;);background-position:0% 0%"/><noscript><img alt="Profile" srcSet="https://s8508235.github.io/blog/_next/static/media/profile.7ee99ab4.png?auto=format&amp;fit=max&amp;w=64 1x, https://s8508235.github.io/blog/_next/static/media/profile.7ee99ab4.png?auto=format&amp;fit=max&amp;w=128 2x" src="https://s8508235.github.io/blog/_next/static/media/profile.7ee99ab4.png?auto=format&amp;fit=max&amp;w=128" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><p class="text-base leading-7">Written by<!-- --> <a class="font-semibold" target="_blank" rel="noreferrer noopener" href="https://github.com/s8508235">s8508235</a> <b>[ZH-TW/EN]</b><br/>Before being good at writing, I have to start writing.<!-- --> </p></div></footer></article><nav class="flex flex-wrap justify-between mb-10"><a class="text-lg font-bold" href="/blog/post/openssl-escape-character">← <!-- -->Openssl escape character</a><div></div></nav></main><footer class="text-lg font-light">© <!-- -->2023<!-- --> If you have any questions, please send me <a href="mailto:a8508235@gmail.com">an email</a>!</footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Hyper V wireguard","date":"June 30, 2023","description":"add hyper v vm and setup wireguard server"},"post":{"content":" \n## Prerequisite knowledge\n- Hyper V\n- Wireguard\n\n## Step 1 新增 VM\n[新增 hyper-v VM](https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v)\n(個人是使用 ubuntu server)\n\n[並使用 external switch](https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines)\n\n## Step 2 安裝 wireguard\n新增 user 等 linux 設定這邊跳過，需要的話請參考[鳥哥私房菜](https://linux.vbird.org/linux_basic/centos7/0410accountmanager.php)\n```sh\nsudo apt install wireguard\n```\n## Step 3 設定 server\n[生成 wireguard config](https://www.wireguardconfig.com/) (記得不要關掉，後面還會用到)\n\n加上 DNS 後(建議)將 server config 存成 `wg0.conf` 並使用\n\n```sh\nwg-quick up ./wg0.conf\n```\n\n開啟 server (wg-quick 需要 sudo)。\n\n如網路沒通，需要在 `wg0.conf` 的`[Interface]`中加上\n\n```conf\nPreUp = sysctl -w net.ipv4.ip_forward=1\nPreUp = sysctl -w net.ipv6.conf.all.forwarding=1\n```\n讓網路能夠 forward (或直接跑這兩個指令，只需要設定一次)。\n\n## Step 3.5 查看 server\n到這邊 server 的部分就結束了，\n可以使用\n```\nwatch -n 1 sudo wg\n```\n來看 wireguard 的情況。\n\n## Step 4 client 安裝\n在需要的機器上下載 [wireguard 用戶端](https://www.wireguard.com/install/)\n\n並將 client config (生成 wireguard config 部分) 存成 `wg0.conf` 將其匯入用戶端便可使用\n\n\n## Optional\n因為通常家裡都是浮動 IP，所以需要 DDNS，\n\n這邊使用 [DuckDNS](https://www.duckdns.org/)，記得先安裝 curl\n```sh\nsudo apt install curl\n```\n\n註冊完後可以有 5 個 DDNS 的名額，依照[linux cron 的步驟](https://www.duckdns.org/install.jsp)設定，\n(DuckDNS 很貼心都有換成你自己的 token 和 domain)\n\n並可得到 `xxx.duckdns.org` 的 domain，將其輸入在 Endpoint 的地方即可( port 要留著)。\n\n## Final words\n將之前寫的 [AWS wireguard setup](https://github.com/s8508235/wireguard-terraform-install) 用 windows hyper-v 實現一次，\n後來才發現有別人寫好的 [windows solution](https://github.com/micahmo/WgServerforWindows)，有興趣的可以研究一下。","excerpt":""},"previousPost":{"slug":"openssl-escape-character","frontmatter":{"title":"Openssl escape character","date":"January 8, 2022","description":"Be careful about the escape character as Linux input"},"excerpt":"","content":" \nFirst of all, I pick [HTTP signature](https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12) as my authorization method.\n\nI use [Vegeta](https://github.com/tsenart/vegeta) to load test my API service.\n\nWhen writing a script for target generation, I need to make a signature for each request.\n\nSo I used `openssl` to generate it.\n```\necho -n \"${message}\" | openssl dgst -sha256 -hmac \"${secret}\" -binary | base64\n```\nBut I did not pass my authenticator.\n\nAfter some trying(use other language to reproduce what happened), I found that message used for generation was weird.(check the byte)\n\nGo:\n```go\nimport (\n\t\"crypto/hmac\"\n\t\"crypto/sha256\"\n\tb64 \"encoding/base64\"\n)\n// https://go.dev/play/p/JaDyZh_wNqn\nfunc hmacSha256(data string, secret string) string {\n\th := hmac.New(sha256.New, []byte(secret))\n\th.Write([]byte(data))\n\treturn b64.URLEncoding.EncodeToString(h.Sum(nil))\n}\n```\n\nNode:\n```javascript\nvar crypto = require('crypto');\nfunction hmacSha256(message, secret) {\n    hmac = crypto.createHmac('sha256', secret);\n    hmac.update(message);\n    return hmac.digest('base64')\n}\n```\n\nWhen make `a\\nmessage` as argument in Linux, it would be the same as `a\\\\nmessage`.\n\nUse \n```\necho -e -n \"${message}\" | openssl dgst -sha256 -hmac \"${secret}\" -binary | base64\n``` \ninstead.\n\nThis was why my target generation script didn't pass the authenticator.\n\nI had definitely known how the escape character works, but I didn't check it in the first place.\n\nWhen using escape character as Linux input, you should be careful about it.\n\nOpenssl might be a misplace but never mind. I found the problem from it.\n\nJust write a note to remember the time wasted on it."},"nextPost":null},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"hyper-v-wireguard"},"buildId":"6ZXqLECLhYggqrX93Splm","assetPrefix":"/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
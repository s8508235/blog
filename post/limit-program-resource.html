<!DOCTYPE html><html lang="zh-TW"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if(!e)return localStorage.setItem('theme','system'),d.add('system');if("system"===e){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else d.add(e)}catch(e){}}()</script><title>使用 cgroups 來限制資源 | s8508235&#x27;s blog</title><meta name="description" content="cgroups 是 control groups，為 linux 核心的一個功能"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="使用 cgroups 來限制資源"/><meta name="og:description" property="og:description" content="cgroups 是 control groups，為 linux 核心的一個功能"/><link rel="icon" type="image/png" href="/static/favicon.ico"/><link rel="apple-touch-icon" href="/static/favicon.ico"/><meta name="next-head-count" content="10"/><link rel="preload" href="/blog/_next/static/css/1ecd44fb4bdb1165231d.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/1ecd44fb4bdb1165231d.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/blog/_next/static/chunks/main-2a7b2b17d48038613683.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/framework.d2e6186d001d2275b0af.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/commons.79d32f475c5c6ab44fcb.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/_app-1f923ec6494065f168dd.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.3a035f8cfd97250ccb49.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/post/%5Bslug%5D-abdbdb7c7002f82d28c4.js" as="script"/></head><body><div id="__next"><div class="w-full min-h-screen bg-gray-100 dark:bg-gray-700 dark:text-white"><div class="max-w-screen-sm px-4 py-12 mx-auto antialiased font-body"><header class="flex items-center justify-between  mb-2"><div class="max-w-md"><h1><a class="text-2xl font-black text-blue-800 no-underline font-display dark:text-blue-400" href="/">Minimal blog</a></h1></div></header><main><article><header class="mb-8"><h1 class="mb-2 text-5xl font-black leading-none font-display">使用 cgroups 來限制資源</h1><p class="text-sm">November 20, 2020</p></header><div class="mb-4 prose lg:prose-lg dark:prose-dark"><p>來限制 memory 來簡單示範一下 cgroups</p><h3>Disclaimer</h3><p>我不知道這是不是正確的作法，因為從 docker 得到了 cgroups 相關知識，用來這邊，那麼進入正文</p><hr/><h3>Installation</h3><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>apt install cgroup-tools</span></code></pre><p>or</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>yum install libcgroup
</span>yum install libcgroup-tools
</code></pre><h3>建立 cgroup</h3><p><code>cgcreate  -g subsystems:path</code> <del>詳情請洽 red hat 官網</del></p><p>關於 subsystem 也可以去 <code>/sys/fs/cgroup</code> 下面看內建的</p><p>也會看到其他教學是直接在 <code>/sys/fs/cgroup/</code> 下直接加資料夾，也會自動幫你加完相關檔案</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>sudo cgcreate -g memory:/mem_test</span></code></pre><h3>增加限制</h3><p>可以看到在新增 cgroup 後，可以發現 <code>/sys/fs/cgroup/memory/memory_test</code> 下面多了一些檔案</p><p>這邊主要看 <code>memory.limit_in_bytes</code> 和 <code>memory.usage_in_bytes</code> 就好，</p><p>用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>cat /sys/fs/cgroup/memory/memory_test/memory.limit_in_bytes</span></code></pre><p>或</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>cgget -g memory:mem_test | grep memory.limit_in_bytes</span></code></pre><p>來查看設定，接著是用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>cgset -r memory.limit_in_bytes=100G mem_test</span></code></pre><p><del>為什麼這邊不一樣啊! <small>如果沒有變的話就加上 sudo </small></del></p><h3>執行程式</h3><p><code>cgexec -g memory:/mem_test command [argument]</code></p><p>例如:</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>cgexec -g memory:/mem_test ping 8.8.8.8</span></code></pre><h3>觀察</h3><p>可以使用以下指令來看在這個 cgroup 執行的 process</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>systemd-cgls memory:/mem_test</span></code></pre><p>看在 cgroup 使用的 memory <del>應該有更好的方法，歡迎提供</del></p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>watch -n 1 &quot;cgget -g memory:mem_test | grep memory.usage_in_bytes&quot;</span></code></pre><h3>刪除 cgroup</h3><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>sudo cgdelete memory:/mem_test</span></code></pre><h3>Conclusion</h3><p>這樣就完成簡單的限制資源，還有其他 subsystem ( cpu, blkio, devices 等等) 可以實作，也可以互相組合，雖然是被大量應用在各種容器技術中，但也是可以簡單拿出來用用看。<del>大概吧</del></p><h3>Reference</h3><ul><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-using_control_groups">Red hat Resource management Chapter 2</a></li></ul></div><hr class="mt-4"/><footer><div class="flex items-center mt-8 mb-16"><picture class="flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14"><source type="image/webp" data-srcset="/blog/_next/static/images/profile-9f01dd8fafca73bac7d478af9843a4a0.png.webp"/><source type="image/png" data-srcset="/blog/_next/static/images/profile-3b1af1481b80686659714779c6b8972a.png"/><img class="lazyload blur flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14" alt="Profile" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAICAYAAADA+m62AAAAAklEQVR4AewaftIAAAEHSURBVDXBP8qCcBzA4c/3l4qkYQWBISGuzdHQ7AnaOkC3aW1o6AKewAO4BY2BQzS0iENDlOS/enF4n0eWy+VvvV6zWq3I8xzP83g+n5xOJ6IoQkQwDAPNcRy22y2j0Yg0TbFtm858PkdE2O/3TCYT1Gw2Q0QoigJd16nrmjiOeb/fJEnCdDqlqiq0LMt4PB6Mx2N0XadpGqqqoigKDocDIsJms0EZhsH5fKYsS77fL0opwjBkMBjwb7FYoC6XC57ncTweud1uNE1Dv9+nbVtEhI7ruqjX68VutyMIAjRNwzRNOpZlUZYlHaUU2nA4JE1T7vc7vu9zvV7p9XqYpsnn88GyLLIs4w/ICWSBF26ZzgAAAABJRU5ErkJggg=="/></picture><p class="text-base leading-7">Written by <a class="font-semibold" href="https://github.com/s8508235" target="_blank" rel="noreferrer noopener">s8508235</a> <b>[ZH-TW/EN]</b><br/>Before being good at writing, I have to start writing.<!-- --> </p></div></footer></article><nav class="flex flex-wrap justify-between mb-10"><div></div><div></div></nav></main><footer class="text-lg font-light">© <!-- -->2021<!-- --> If you have any problem, feel free to <a href="mailto:a8508235@gmail.com">contact me!</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"使用 cgroups 來限制資源","date":"November 20, 2020","description":"cgroups 是 control groups，為 linux 核心的一個功能"},"post":{"content":"\n來限制 memory 來簡單示範一下 cgroups\n\n### Disclaimer\n我不知道這是不是正確的作法，因為從 docker 得到了 cgroups 相關知識，用來這邊，那麼進入正文\n\n---\n### Installation\n```\napt install cgroup-tools\n```\n\nor\n``` \nyum install libcgroup\nyum install libcgroup-tools\n```\n### 建立 cgroup\n\n```cgcreate  -g subsystems:path``` \u003cdel\u003e詳情請洽 red hat 官網\u003c/del\u003e\n\n關於 subsystem 也可以去 `/sys/fs/cgroup` 下面看內建的\n\n也會看到其他教學是直接在 `/sys/fs/cgroup/` 下直接加資料夾，也會自動幫你加完相關檔案\n\n```\nsudo cgcreate -g memory:/mem_test\n```\n\n### 增加限制\n\n可以看到在新增 cgroup 後，可以發現 `/sys/fs/cgroup/memory/memory_test` 下面多了一些檔案\n\n這邊主要看 `memory.limit_in_bytes` 和 `memory.usage_in_bytes` 就好，\n\n用 \n```\ncat /sys/fs/cgroup/memory/memory_test/memory.limit_in_bytes\n``` \n或 \n```\ncgget -g memory:mem_test | grep memory.limit_in_bytes\n``` \n來查看設定，接著是用 \n```\ncgset -r memory.limit_in_bytes=100G mem_test\n``` \n\u003cdel\u003e為什麼這邊不一樣啊! \u003csmall\u003e如果沒有變的話就加上 sudo \u003c/small\u003e\u003c/del\u003e\n\n### 執行程式\n\n`cgexec -g memory:/mem_test command [argument]`\n\n例如:\n```\ncgexec -g memory:/mem_test ping 8.8.8.8\n```\n\n### 觀察\n\n可以使用以下指令來看在這個 cgroup 執行的 process\n```\nsystemd-cgls memory:/mem_test\n``` \n\n看在 cgroup 使用的 memory \u003cdel\u003e應該有更好的方法，歡迎提供\u003c/del\u003e\n\n```\nwatch -n 1 \"cgget -g memory:mem_test | grep memory.usage_in_bytes\"\n``` \n\n\n### 刪除 cgroup\n\n```\nsudo cgdelete memory:/mem_test\n```\n\n### Conclusion\n\n這樣就完成簡單的限制資源，還有其他 subsystem ( cpu, blkio, devices 等等) 可以實作，也可以互相組合，雖然是被大量應用在各種容器技術中，但也是可以簡單拿出來用用看。\u003cdel\u003e大概吧\u003c/del\u003e\n\n### Reference\n- [Red hat Resource management Chapter 2](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-using_control_groups)","excerpt":""},"previousPost":null,"nextPost":null},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"limit-program-resource"},"buildId":"DMsrtRVzC9BDevBnkMWM_","assetPrefix":"/blog","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/blog/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/blog/_next/static/chunks/main-2a7b2b17d48038613683.js" async=""></script><script src="/blog/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/blog/_next/static/chunks/framework.d2e6186d001d2275b0af.js" async=""></script><script src="/blog/_next/static/chunks/commons.79d32f475c5c6ab44fcb.js" async=""></script><script src="/blog/_next/static/chunks/pages/_app-1f923ec6494065f168dd.js" async=""></script><script src="/blog/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.3a035f8cfd97250ccb49.js" async=""></script><script src="/blog/_next/static/chunks/pages/post/%5Bslug%5D-abdbdb7c7002f82d28c4.js" async=""></script><script src="/blog/_next/static/DMsrtRVzC9BDevBnkMWM_/_buildManifest.js" async=""></script><script src="/blog/_next/static/DMsrtRVzC9BDevBnkMWM_/_ssgManifest.js" async=""></script></body></html>